<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Điều khiển Động cơ Bước - Arduino</title>
    <style>
        :root {
            --primary-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f1c40f;
            --dark-color: #2c3e50;
            --background: #ecf0f1;
        }

        body {
            font-family: 'Roboto', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: var(--background);
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
        }

        .connected { background: var(--primary-color); }
        .disconnected { background: var(--danger-color); }

        input[type="range"] {
            width: 100%;
            margin: 15px 0;
        }

        #position {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--dark-color);
            text-align: center;
            margin: 20px 0;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
    <div class="panel">
        <h1>Điều khiển Động cơ Bước <span id="status" class="status-indicator disconnected"></span></h1>
        
        <div class="panel">
            <button id="connectBtn" class="btn btn-primary">Kết nối Arduino</button>
            <button id="emergencyStop" class="btn btn-danger">Dừng khẩn cấp</button>
        </div>

        <div class="panel">
            <label>Tốc độ (%): <span id="speedValue">50</span></label>
            <input type="range" id="speed" min="1" max="100" value="50">
            
            <label>Số vòng: <span id="revsValue">1</span></label>
            <input type="range" id="revs" min="0.1" max="10" step="0.1" value="1">
            
            <label>Vi bước:
                <select id="microstep">
                    <option value="1">1x</option>
                    <option value="2">2x</option>
                    <option value="4">4x</option>
                    <option value="8">8x</option>
                    <option value="16">16x</option>
                </select>
            </label>
        </div>

        <div class="panel">
            <button id="forwardBtn" class="btn btn-primary">Quay Thuận</button>
            <button id="reverseBtn" class="btn btn-primary">Quay Nghịch</button>
            <div id="position">0</div>
        </div>
    </div>

    <script>
        let port;
        let reader;
        let isConnected = false;

        // Cấu hình động cơ
        const config = {
            stepsPerRev: 200,
            maxSpeed: 1000 // steps/giây
        };

        // Elements
        const connectBtn = document.getElementById('connectBtn');
        const statusIndicator = document.getElementById('status');
        const positionDisplay = document.getElementById('position');

        // Kết nối Serial
        async function connectSerial() {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                
                reader = port.readable.getReader();
                isConnected = true;
                updateUI();
                readData();
                
                connectBtn.textContent = "Ngắt kết nối";
                statusIndicator.className = "status-indicator connected";
                
            } catch (error) {
                console.error('Lỗi kết nối:', error);
                alert('Lỗi kết nối: ' + error.message);
            }
        }

        // Đọc dữ liệu từ Arduino
        async function readData() {
            while (isConnected) {
                try {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    const text = new TextDecoder().decode(value);
                    processIncomingData(text);
                    
                } catch (error) {
                    console.error('Lỗi đọc dữ liệu:', error);
                    disconnect();
                }
            }
        }

        // Xử lý dữ liệu nhận
        function processIncomingData(data) {
            const messages = data.split('\n');
            
            messages.forEach(msg => {
                if (msg.startsWith('POS:')) {
                    const position = msg.substr(4).trim();
                    positionDisplay.textContent = position;
                }
                else if (msg.startsWith('ERR:')) {
                    handleError(msg.substr(4));
                }
            });
        }

        // Gửi lệnh điều khiển
        async function sendCommand(command) {
            if (!isConnected) return;
            
            const writer = port.writable.getWriter();
            await writer.write(new TextEncoder().encode(command + '\n'));
            writer.releaseLock();
        }

        // Xử lý lỗi
        function handleError(errorMsg) {
            alert(`Lỗi: ${errorMsg}`);
            sendCommand('S');
        }

        // Ngắt kết nối
        function disconnect() {
            isConnected = false;
            reader.cancel();
            port.close();
            updateUI();
            connectBtn.textContent = "Kết nối Arduino";
            statusIndicator.className = "status-indicator disconnected";
        }

        // Cập nhật giao diện
        function updateUI() {
            const controls = document.querySelectorAll('button, input');
            controls.forEach(control => {
                if (control.id !== 'connectBtn') {
                    control.disabled = !isConnected;
                }
            });
        }

        // Event Listeners
        connectBtn.addEventListener('click', () => {
            isConnected ? disconnect() : connectSerial();
        });

        document.getElementById('forwardBtn').addEventListener('click', () => {
            const speed = document.getElementById('speed').value;
            const revs = document.getElementById('revs').value;
            const microstep = document.getElementById('microstep').value;
            const steps = revs * config.stepsPerRev * microstep;
            
            sendCommand(`F${speed}|${steps}`);
        });

        document.getElementById('reverseBtn').addEventListener('click', () => {
            const speed = document.getElementById('speed').value;
            const revs = document.getElementById('revs').value;
            const microstep = document.getElementById('microstep').value;
            const steps = revs * config.stepsPerRev * microstep;
            
            sendCommand(`R${speed}|${steps}`);
        });

        document.getElementById('emergencyStop').addEventListener('click', () => {
            sendCommand('S');
        });

        // Cập nhật giá trị real-time
        document.getElementById('speed').addEventListener('input', (e) => {
            document.getElementById('speedValue').textContent = e.target.value;
        });

        document.getElementById('revs').addEventListener('input', (e) => {
            document.getElementById('revsValue').textContent = e.target.value;
        });
    </script>
</body>
</html>
